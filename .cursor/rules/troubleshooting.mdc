---
description: "에러 대응 및 트러블슈팅 가이드 - Cursor가 항상 참조"
globs: "**/*"
alwaysApply: true
---

# Troubleshooting Guide

## 빠른 에러 대응 체크리스트

### 1. Expo/React Native 일반
| 증상 | 원인 | 해결 |
|------|------|------|
| Metro bundler 멈춤 | 캐시 문제 | `npx expo start -c` |
| 앱 크래시 | 패키지 충돌 | `rm -rf node_modules && npm install` |
| 화면 빈 화면 | 렌더링 에러 | 콘솔 에러 확인 후 해당 컴포넌트 수정 |
| TypeScript 에러 | 타입 불일치 | `types/` 폴더 확인 |

### 2. expo-three / 3D 관련
| 증상 | 원인 | 해결 |
|------|------|------|
| GL 컨텍스트 생성 실패 | 디바이스 미지원 | 2D Fallback 사용 |
| 검은 화면 | `gl.endFrameEXP()` 누락 | animate 함수에 추가 |
| 메모리 초과 | 폴리곤 과다 | segment 16-32로 제한 |
| 텍스처 안 보임 | 비동기 로딩 | TextureLoader 콜백 확인 |

### 3. OpenAI API 관련
| 증상 | 원인 | 해결 |
|------|------|------|
| 401 Unauthorized | API 키 오류 | `.env` 파일 확인 |
| 429 Rate Limit | 요청 과다 | 재시도 로직 + 폴백 메시지 |
| 스트리밍 중단 | 네트워크 끊김 | try-catch + 에러 메시지 |
| 응답 너무 김 | max_tokens 미설정 | max_tokens: 150 설정 |
| Response body is null | Expo/RN fetch 미지원 | 비스트리밍(stream: false) 사용 |

### 4. NativeWind / 스타일링
| 증상 | 원인 | 해결 |
|------|------|------|
| 스타일 미적용 | tailwind.config 누락 | content 경로 확인 |
| className 에러 | babel 설정 누락 | `nativewind/babel` 플러그인 확인 |

### 5. 상태관리 (Zustand)
| 증상 | 원인 | 해결 |
|------|------|------|
| 상태 초기화됨 | 앱 재시작 | AsyncStorage persist 설정 |
| 상태 업데이트 안됨 | 불변성 위반 | spread 연산자로 새 객체 생성 |

## 긴급 폴백 전략

### 3D 렌더링 실패 시
```typescript
// components/Terrarium/TerrariumScene.tsx
const [glSupported, setGlSupported] = useState(true);

if (!glSupported) {
  return <Terrarium2DFallback items={items} />;
}
```

### AI 응답 실패 시
```typescript
// 하드코딩 폴백 응답
const FALLBACK_RESPONSES = [
  "오늘도 수고했어 🌱",
  "괜찮아, 쉬어도 돼 🌿",
  "네 마음 알아 ✨",
];
```

### 환경변수 누락 시
```typescript
const apiKey = process.env.EXPO_PUBLIC_OPENAI_API_KEY;
if (!apiKey) {
  console.warn('API key missing, using fallback mode');
  return useFallbackResponses();
}
```

## 에러 로깅 규칙

에러 발생 시 반드시 기록:
1. **파일**: `.cursor/knowledge/error-solutions.md`
2. **형식**:
```markdown
### [날짜] 에러 제목
- **증상**: 무슨 일이 발생했는지
- **원인**: 왜 발생했는지
- **해결**: 어떻게 해결했는지
- **파일**: 관련 파일 경로
```

## Phase별 예상 에러

### Phase 1 (환경 설정)
- 패키지 버전 충돌 → package.json 버전 고정
- peer dependency 경고 → `--legacy-peer-deps` 옵션

### Phase 2 (3D + 상점)
- GLView 렌더링 실패 → 2D 폴백 준비
- 타입 에러 → FE-2가 types/ 먼저 확정

### Phase 3 (AI 챗봇)
- API 키 에러 → 팀 공유 확인
- 스트리밍 실패 → 비스트리밍(stream: false)으로 통일

### Phase 4 (감정 루틴)
- 애니메이션 버벅임 → 60fps 유지 확인
- AsyncStorage 에러 → 데이터 형식 확인

### Phase 5 (QA)
- 15:00 이후 새 기능 금지
- 크리티컬 버그만 수정

## 참조 파일

- 에러 해결 기록: `.cursor/knowledge/error-solutions.md`
- AI-1 작업 가이드: `.cursor/commands/ai1-all-tasks.md` (에러 없이 구현하기 섹션)
