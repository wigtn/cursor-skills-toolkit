---
description: AI-2 ì—­í•  - íƒ€ì… ì •ì˜, ë¬¸ì„œ, ê·œì¹™, ì½˜í…ì¸ , í†µí•© ê´€ë¦¬
globs: shared/**, docs/**, .cursor/**, README.md, .env.example
alwaysApply: false
---

# AI-2: íƒ€ì… / ë¬¸ì„œ / ê·œì¹™ / í†µí•© ë‹´ë‹¹
# ì ìš© ê²½ë¡œ: shared/**, docs/**, .cursor/**, README.md, .env.example

## ë‹´ë‹¹ ì˜ì—­
- `shared/` â€” ê³µìœ  íƒ€ì…, ë©”ì‹œì§€ í”„ë¡œí† ì½œ, ìƒìˆ˜
- `docs/` â€” PRD, PLAN, ê°€ì´ë“œ ë¬¸ì„œ
- `.cursor/rules/` â€” Cursor ê·œì¹™ ê´€ë¦¬
- `.cursor/commands/` â€” ì—­í• ë³„ íƒœìŠ¤í¬ ì»¤ë§¨ë“œ
- `.cursor/knowledge/` â€” ì—ëŸ¬ í•´ê²° ì§€ì‹ë² ì´ìŠ¤
- `README.md`, `.env.example`

## shared/ íŒŒì¼ êµ¬ì¡°
```
shared/
â”œâ”€â”€ types.ts                # ì „ì²´ ê³µìœ  íƒ€ì… ì •ì˜
â”œâ”€â”€ message-protocol.ts     # WebView â†” Native ë©”ì‹œì§€ ê·œê²©
â””â”€â”€ constants.ts            # ê³µìœ  ìƒìˆ˜
```

### shared/types.ts
```typescript
// === ìºë¦­í„° ì´ë¦„ ===
export const ROBOT_NAME = 'ë˜ë´‡' as const;
export const STONE_NAME = 'ëŒëŒì´' as const;

// === ëŒëŒì´ ê°ì • ===
export type StoneEmotion = 'calm' | 'happy' | 'sad' | 'excited' | 'sleepy';

export interface StoneState {
  emotion: StoneEmotion;
  lastInteraction: number;  // timestamp
  name: string;             // 'ëŒëŒì´'
}

export const STONE_EMOTION_TRIGGERS: Record<StoneEmotion, string[]>;

// === ë¡œë´‡ ì•¡ì…˜ ===
export type RobotAction = 'plant_flower' | 'water' | 'clean' | 'dance' | 'wave' | 'check_status' | 'idle';

// === ëª…ë ¹ ì˜ë„ ===
export type CommandIntent = 'decorate' | 'care' | 'status' | 'chat' | 'special';

// === ëª…ë ¹ ê²°ê³¼ ===
export interface CommandResult {
  intent: CommandIntent;
  action: RobotAction | null;
  item: string | null;
  response: string;
  stoneEmotionChange?: StoneEmotion | null;
}

// === ì•¡ì…˜ â†’ ì• ë‹ˆë©”ì´ì…˜ ë§¤í•‘ ===
export const ACTION_TO_ANIMATION: Record<RobotAction, RobotAnimation>;

// === í—¬í¼ í•¨ìˆ˜ ===
export const detectCommandIntent = (text: string): CommandIntent;
export const detectStoneEmotion = (text: string): StoneEmotion | undefined;

// === ê²Œì„ ìƒíƒœ ===
export interface GameState {
  stone: StoneState;
  currentAnimation: RobotAnimation;
  lastInputText: string | null;
  interactionCount: number;
  totalPlayTime: number;
}

// === ë¡œë´‡ ì• ë‹ˆë©”ì´ì…˜ ===
export const ROBOT_ANIMATIONS = [
  'Idle', 'Walking', 'Running', 'Dance', 'Death',
  'Sitting', 'Standing', 'Jump', 'Yes', 'No',
  'Wave', 'Punch', 'ThumbsUp',
] as const;
export type RobotAnimation = typeof ROBOT_ANIMATIONS[number];

// === ì±„íŒ… ===
export interface ChatMessage {
  id: string;
  role: 'user' | 'robot';
  content: string;
  timestamp: number;
}

// === í…Œë¼ë¦¬ì›€ ì•„ì´í…œ ===
export interface TerrariumItem {
  id: string;
  name: string;
  type: 'plant' | 'decoration' | 'stone';
  description: string;
  price: number;
}
```

### shared/message-protocol.ts
```typescript
// ì´ íŒŒì¼ì€ íŒ€ ì „ì²´ í•©ì˜ ì—†ì´ ìˆ˜ì • ê¸ˆì§€!
// WebView â†” Native í†µì‹ ì˜ ìœ ì¼í•œ ê³„ì•½ì…ë‹ˆë‹¤.

// === ë©”ì‹œì§€ íƒ€ì… ===
export type NativeToWebMessageType =
  | 'RECORDING_START'     // ë…¹ìŒ ì‹œì‘ë¨
  | 'VOICE_RESULT'        // STT ê²°ê³¼
  | 'TEXT_INPUT'          // í…ìŠ¤íŠ¸ ì…ë ¥ (ì‹ ê·œ)
  | 'APP_STATE_CHANGED';  // ì•± foreground/background

export type WebToNativeMessageType =
  | 'READY'                   // ì›¹ ë¡œë“œ ì™„ë£Œ
  | 'ANIMATION_CHANGED'       // ì• ë‹ˆë©”ì´ì…˜ ë³€ê²½ ì•Œë¦¼
  | 'ROBOT_RESPONSE'          // ë¡œë´‡ ì‘ë‹µ (ì‹ ê·œ)
  | 'STONE_EMOTION_CHANGED';  // ëŒëŒì´ ê°ì • ë³€í™” (ì‹ ê·œ)

// === ë©”ì‹œì§€ êµ¬ì¡° ===
export interface BridgeMessage<T = unknown> {
  type: NativeToWebMessageType | WebToNativeMessageType;
  payload: T;
}

// === í˜ì´ë¡œë“œ íƒ€ì… ===
export interface VoiceResultPayload { text: string; }
export interface TextInputPayload { text: string; }
export interface AnimationChangedPayload { animation: string; }
export interface RobotResponsePayload { text: string; action?: RobotAction; intent?: CommandIntent; }
export interface StoneEmotionChangedPayload { emotion: StoneEmotion; previousEmotion?: StoneEmotion; }

// === ìƒíƒœ ë¨¸ì‹  ===
export type AppMessageState =
  | 'IDLE'
  | 'RECORDING'
  | 'PROCESSING_STT'
  | 'PROCESSING_TEXT'  // í…ìŠ¤íŠ¸ ì…ë ¥ ì²˜ë¦¬ (ì‹ ê·œ)
  | 'PROCESSING_AI'
  | 'ANIMATING';

// IDLEì—ì„œ PROCESSING_TEXTë¡œ ì „í™˜ ê°€ëŠ¥
export const MESSAGE_STATE_TRANSITIONS: Record<AppMessageState, AppMessageState[]>;

// === Native â†’ WebView ì „ì†¡ ë°©ë²• ===
// webViewRef.current.injectJavaScript(
//   `window.postMessage(JSON.stringify({type, payload}), '*'); true;`
// )

// === WebView â†’ Native ì „ì†¡ ë°©ë²• ===
// window.ReactNativeWebView?.postMessage(JSON.stringify({type, payload}))
```

### shared/constants.ts
```typescript
// í™˜ê²½ë³€ìˆ˜ í‚¤
export const ENV_KEYS = {
  OPENAI_API_KEY: 'EXPO_PUBLIC_OPENAI_API_KEY',
  COIN_INTERVAL: 'EXPO_PUBLIC_COIN_INTERVAL',
  MAX_TOKENS: 'EXPO_PUBLIC_MAX_TOKENS',
  DEBUG: 'EXPO_PUBLIC_DEBUG',
  FORCE_2D_FALLBACK: 'EXPO_PUBLIC_FORCE_2D_FALLBACK',
} as const;

// OpenAI ì„¤ì •
export const OPENAI_CONFIG = {
  STT_MODEL: 'whisper-1',
  CHAT_MODEL: 'gpt-4o-mini',
  MAX_TOKENS: 150,
  TEMPERATURE: 0.8,
  LANGUAGE: 'ko',
} as const;

// ë¡œë´‡(ë˜ë´‡) ì´ëª¨ì§€ í—ˆìš© ëª©ë¡
export const ROBOT_EMOJIS = ['ğŸ¤–', 'ğŸ”§', 'ğŸ’§', 'ğŸŒ¸', 'ğŸŒ¿', 'âœ¨', 'ğŸ’ª', 'ğŸ‘', 'ğŸµ', 'ğŸ˜Š'] as const;

// ë¡œë´‡ í´ë°± ì‘ë‹µ (API ì—ëŸ¬ ì‹œ)
export const ROBOT_FALLBACK_RESPONSES = [
  'ì•—, ì ê¹ ë©í•´ì¡Œì–´ìš”... ë‹¤ì‹œ ë§í•´ì£¼ì‹¤ë˜ìš”? ğŸ¤–',
  'ë„¤ë„¤! ì§€ê¸ˆ ë°”ë¡œ í• ê²Œìš”~ ğŸ’ª',
  ...
] as const;

// ëŒëŒì´ ê°ì •ë³„ ë©”ì‹œì§€
export const STONE_EMOTION_MESSAGES: Record<StoneEmotion, string[]>;

// ëª…ë ¹ ì˜ë„ë³„ ì˜ˆì‹œ
export const COMMAND_EXAMPLES: Record<CommandIntent, string[]>;

// ë”ë¯¸ STT ë¬¸ì¥ (API í‚¤ ì—†ì„ ë•Œ)
export const DUMMY_STT_SENTENCES = [
  'ì•ˆë…•! ë°˜ê°€ì›Œ!',
  'ê½ƒì„ ì‹¬ì–´ì¤˜',
  'ë¬¼ ì¢€ ì¤˜',
  ...
] as const;

// WebView URL
export const WEB_URLS = {
  DEV_IOS: (ip: string) => `http://${ip}:5173`,
  DEV_ANDROID: 'http://10.0.2.2:5173',
  DEV_DEFAULT: 'http://localhost:5173',
  PRODUCTION: 'https://your-deployed-url.com',
} as const;
```

## .cursor/commands/ íƒœìŠ¤í¬ ì»¤ë§¨ë“œ

### íŒŒì¼ êµ¬ì¡°
```
.cursor/commands/
â”œâ”€â”€ phase1-setup.md           # ì „ì›: í™˜ê²½ ì„¤ì •
â”œâ”€â”€ fe1-all-tasks.md          # FE-1: Expo ì•± íƒœìŠ¤í¬
â”œâ”€â”€ fe2-all-tasks.md          # FE-2: 3D ì”¬ íƒœìŠ¤í¬
â”œâ”€â”€ ai1-all-tasks.md          # AI-1: ì±„íŒ…/AI íƒœìŠ¤í¬
â””â”€â”€ ai2-all-tasks.md          # AI-2: íƒ€ì…/ë¬¸ì„œ íƒœìŠ¤í¬
```

### ì»¤ë§¨ë“œ ì‚¬ìš©ë²•
Cursorì—ì„œ `@commands` ë˜ëŠ” íŒŒì¼ì„ ì—´ê³  "ì´ íƒœìŠ¤í¬ ì§„í–‰í•´ì¤˜"ë¼ê³  ì§€ì‹œ.

## .cursor/knowledge/ ì—ëŸ¬ ì§€ì‹ë² ì´ìŠ¤

### ê¸°ë¡ í˜•ì‹
```markdown
## [ì—ëŸ¬ ì œëª©]
- **ë‚ ì§œ**: YYYY-MM-DD
- **ìƒíƒœ**: í•´ê²°ë¨ / ë¯¸í•´ê²°
- **ì¦ìƒ**: ì–´ë–¤ ì—ëŸ¬ê°€ ë°œìƒí–ˆëŠ”ì§€
- **ì›ì¸**: ì™œ ë°œìƒí–ˆëŠ”ì§€
- **í•´ê²°**: ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€
- **ê´€ë ¨ íŒŒì¼**: ì–´ë–¤ íŒŒì¼ì´ ê´€ë ¨ë˜ëŠ”ì§€
```

### ì•Œë ¤ì§„ ì—ëŸ¬ (main ë¸Œëœì¹˜ knowledge ê¸°ì¤€)
1. **expo-three gl.endFrameEXP() ëˆ„ë½** â†’ ê²€ì€ í™”ë©´. animate ë£¨í”„ ë§ˆì§€ë§‰ì— í•„ìˆ˜ í˜¸ì¶œ
2. **OpenAI 401** â†’ API í‚¤ ëˆ„ë½/ë§Œë£Œ. ë”ë¯¸ í´ë°±ìœ¼ë¡œ ì „í™˜
3. **NativeWind ë¯¸ì ìš©** â†’ babel ì„¤ì • ëˆ„ë½
4. **Response body null** â†’ ìŠ¤íŠ¸ë¦¬ë° ëŒ€ì‹  ë¹„ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ ê¶Œì¥

## ë¬¸ì„œ ê´€ë¦¬ ê·œì¹™
- PRD ë³€ê²½ â†’ `docs/prd/` ì— ë²„ì „ ëª…ì‹œ (v5.0, v5.1...)
- PLAN ë³€ê²½ â†’ `docs/todo_plan/` ì— Phase ë²ˆí˜¸ì™€ í•¨ê»˜
- ì•„ì¹´ì´ë¸Œ â†’ `docs/archive/` ë¡œ ì´ë™ (ì‚­ì œ ê¸ˆì§€)

## íƒ€ì… ì‚¬ìš© ì˜ˆì‹œ

### StoneEmotion ì‚¬ìš©
```typescript
import { StoneEmotion, STONE_EMOTION_TRIGGERS, detectStoneEmotion } from '../../shared/types';

// ê°ì • ê°ì§€
const emotion = detectStoneEmotion(userText); // 'happy' | 'sad' | undefined

// ê°ì • íŠ¸ë¦¬ê±° í™•ì¸
if (STONE_EMOTION_TRIGGERS.happy.some(k => text.includes(k))) {
  setStoneEmotion('happy');
}
```

### CommandResult ì‚¬ìš©
```typescript
import { CommandResult, detectCommandIntent, ACTION_TO_ANIMATION } from '../../shared/types';

// ëª…ë ¹ ì˜ë„ íŒŒì•…
const intent = detectCommandIntent(text); // 'decorate' | 'care' | 'status' | 'chat' | 'special'

// AI ì‘ë‹µ ì²˜ë¦¬
const result: CommandResult = await chatWithRobot(text);
if (result.action) {
  const animation = ACTION_TO_ANIMATION[result.action];
  setAnimation(animation);
}
```

### ë©”ì‹œì§€ í”„ë¡œí† ì½œ ì‚¬ìš©
```typescript
import {
  safeParseBridgeMessage,
  isTextInputPayload,
  isVoiceResultPayload,
  canTransition,
} from '../../shared/message-protocol';

// ë©”ì‹œì§€ ìˆ˜ì‹ 
const handleMessage = (event: MessageEvent) => {
  const message = safeParseBridgeMessage(event.data);
  if (!message) return;

  switch (message.type) {
    case 'TEXT_INPUT':
      if (isTextInputPayload(message.payload)) {
        handleUserInput(message.payload.text, 'text');
      }
      break;
    case 'VOICE_RESULT':
      if (isVoiceResultPayload(message.payload)) {
        handleUserInput(message.payload.text, 'voice');
      }
      break;
  }
};

// ìƒíƒœ ì „í™˜ ê²€ì¦
if (canTransition(currentState, 'PROCESSING_TEXT')) {
  setState('PROCESSING_TEXT');
}
```

## ìˆ˜ì • ê¸ˆì§€ ì˜ì—­
- `app/` í´ë” (FE-1 ë‹´ë‹¹)
- `web/src/components/` (FE-2 ë‹´ë‹¹)
- `web/src/App.tsx`, `web/src/main.tsx` (AI-1 ë‹´ë‹¹)
